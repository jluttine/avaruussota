
import java.util.ArrayList;
import java.awt.*;

/**
 * 
 * Luokka <CODE>AvaruussotaPeli<CODE> kuvaa johonkin <CODE>Avaruus<CODE>-luokan olion
 * mallintamaan maailmaan sijoittuvaa melee-taistelupeliä. Pelissä voi olla useita
 * pelaajia ja niille voi määrätä tietokoneohjauksen.
 * Oliota luodessa ja sitä käytetettäessä on hyvä toimia tiettyjen sääntöjen mukaan:
 * Ensin asetetaan pelimaailma ja lisätään halutut pelaajat. Tämän jälkeen tarvitsee
 * vain lähettää kaynnista-komento ja peli alkaa pyöriä aivan itsestään. Kun peli
 * lopetetaan, kutsutaan lopeta-metodia. Tällöin on mahdollista vielä tutkia pelaajien
 * pisteitä ym. Kun kutsutaan tyhjenna-metodia, kaikki pelaajat ja tiedot poistetaan
 * eikä olio tiedä juuri loppuneesta pelistä enää mitään.
 *
 * @author Jaakko Luttinen
 *
 */

public class AvaruussotaPeli {
    
    /**
     * Pelaajien maksimimäärä pelissä.
     */
    public static final int PELAAJIEN_MAKSIMIMAARA = 12;
    
    /**
     * Voiton pistemäärän yläraja. Alaraja on 1.
     */
    public static final int VOITON_MAKSIMIPISTEMAARA = 99;
    
    /**
     * Lista pelissä olevista pelaajista.
     */
    private ArrayList pelaajat;
    
    /**
     * Avaruusmaailma, johon peli sijoittuu.
     */
    private Avaruus maailma;
    
    /**
     * Pelimaailmaa pyörittävä säie.
     */
    private SaiePelimaailma maailmaSaie;
    
    /**
     * Tekoälyjen miettimisistä huolehtiva säie.
     */
    private SaieTietokoneohjaus tekoalySaie;
    
    /**
     * Pistemäärä, joka voittoon tarvitaan.
     */
    private int voitonPistemaara;
    
    /**
     * Tiedosto, jossa pelikenttä on, tai null, jos pelikenttä halutaan generoida.
     */
    private String pelikenttaTiedosto;
    
    /**
     * Totuusarvo, joka kertoo, onko joku pelaajista saavuttanut voiton.
     */
    private boolean peliVoitettu;
    
    /**
     * Luo uuden pelin. Luo tietokoneohjauksen säikeen huolehtimaan tämän pelin
     * tekoälyjen miettimisistä. Asettaa voittoon tarvittavaksi pistemääräksi 1.
     */
    public AvaruussotaPeli() {
        
        this.pelaajat = new ArrayList();
        this.tekoalySaie = new SaieTietokoneohjaus( this );
        this.maailmaSaie = new SaiePelimaailma();
        this.voitonPistemaara = 1;
        
    }

    /**
     * Kertoo pelimaailmaa pyörittävän säikeen.
     * @return Pelimaailmaa pyörittävä säie.
     */
    public SaiePelimaailma kerroPelimaailmaSaie() {
        
        return this.maailmaSaie;
        
    }
    
    /**
     * Kertoo pelaajan, joka annetulla indeksillä löytyy.
     * @param indeksi Pelaajan indeksi.
     * @return Pelaaja, joka annetulla indeksillä löytyy tai null.
     * @throws IndexOutOfBoundsException Poikkeus kertoo, että indeksi on virheellinen eli
     * ei ole välillä 0 - (pelaajien määrä-1).
     */
    public Pelaaja kerroPelaaja( int indeksi ) throws IndexOutOfBoundsException{
        
        if ( indeksi < 0 || indeksi >= this.pelaajat.size() )
            throw new IndexOutOfBoundsException( "Annettu pelaajan indeksi on virheellinen." );
        
        return ( Pelaaja )this.pelaajat.get( indeksi );
        
    }
    
    /**
     * Kertoo pelaajien määrän pelissä.
     * @return Pelaajien määrä pelissä.
     */
    public int kerroPelaajienMaara() {
        
        return this.pelaajat.size();
        
    }

    /**
     * Lisää pelaajan peliin ja huolehtii siitä, että myös pelaaja saa tiedon kuuluvansa
     * tähän peliin. Lisääminen epäonnistuu, jos 1:pelaaja kuuluu jo peliin, 2:pelissä on
     * jo maksimimäärä pelaajia tai 3:pelissä on jo samanniminen pelaaja.
     * @param uusiPelaaja Pelaaja, joka peliin halutaan lisätä.
     * @return Lisätyn pelaajan indeksi tai -1 jos pelaaja on jo pelissä.
     * @throws Exception Poikkeus kertoo, että pelaajan lisääminen epäonnistui (tapaus 2 tai 3).
     */
    public int lisaaPelaaja( Pelaaja uusiPelaaja ) throws Exception {
        
        if ( this.pelaajat.contains( uusiPelaaja ) ) 
            return -1;
        
        //Jos pelaajien maksimimäärä saavutettu --> poikkeus!
        if ( this.pelaajat.size() >= AvaruussotaPeli.PELAAJIEN_MAKSIMIMAARA )
            throw new Exception( "Pelaajaa ei voida lisätä. Pelissä on jo maksimimäärä (" +
                    			  AvaruussotaPeli.PELAAJIEN_MAKSIMIMAARA + ") pelaajia." );
        
        //Jos saman niminen pelaaja jo on pelissä --> poikkeus!
        if ( this.onPelaaja( uusiPelaaja.kerroNimi() ) )
            throw new Exception( "Pelaajaa ei voida lisätä. \"" + uusiPelaaja.kerroNimi() +
                    			 "\"-niminen pelaaja on jo pelissä." );
        
        this.pelaajat.add( uusiPelaaja );
        uusiPelaaja.asetaPeliin( this );

        return this.pelaajat.size() - 1;
        
    }

    /**
     * Poistaa annettua indeksiä vastaavan pelaajan pelistä.
     * @param indeksi Poistettavan pelaajan indeksi.
     * @throws IndexOutOfBoundsException Poikkeus kertoo, että indeksi on virheellinen eli
     * ei ole välillä 0 - (pelaajien määrä-1).
     */
    public void poistaPelaaja( int indeksi ) throws IndexOutOfBoundsException {
        
        if ( indeksi < 0 || indeksi >= this.pelaajat.size() )
            throw new IndexOutOfBoundsException( "Annettu pelaajan indeksi on virheellinen." );
        
        Pelaaja vanhaPelaaja = ( Pelaaja )this.pelaajat.remove( indeksi );
        vanhaPelaaja.poistaPelista();

    }

    /**
     * Jos annettu pelaaja on pelissä, poistetaan se pelistä.
     * @param poistettava Pelaaja, joka pelistä halutaan poistaa.
     */
    public void poistaPelaaja( Pelaaja poistettava ) {
        
        int indeksi = this.pelaajat.indexOf( poistettava );
        
        if ( indeksi >= 0 )
            this.poistaPelaaja( indeksi );
        
    }

    /**
     * Poistaa kaikki pelaajat pelistä.
     */
    public void poistaKaikkiPelaajat() {

        int koko = 0;
        
        while ( ( koko = this.pelaajat.size() ) > 0 )
            this.poistaPelaaja( koko - 1 );
        
    }

    /**
     * Kertoo, onko pelissä annetun niminen pelaaja.
     * @param nimi Nimi, jota etsitään.
     * @return Totuusarvo, joka kertoo, onko pelissä annetun niminen pelaaja.
     */
    public boolean onPelaaja( String nimi ) {
        
        for ( int ind = 0; ind < this.pelaajat.size(); ind++ ) {
            
            if ( ( ( Pelaaja )this.pelaajat.get( ind ) ).kerroNimi().equals( nimi ) )
                return true;
            
        }
        
        return false;
        
    }
    
    /**
     * Nollaa kaikkien pelin pelaajien pisteet. Laskee voittoehtojen täyttymisen
     * merkiksi nostetun lipun.
     */
    public void nollaaPelaajienPisteet() {
        
        for ( int ind = 0; ind < this.pelaajat.size(); ind++ )
            ( ( Pelaaja )this.pelaajat.get( ind ) ).nollaaPisteet();
        
        this.peliVoitettu = false;
            
    }

    /**
     * Kertoo avaruusmaailman, johon peli sijoittuu.
     * @return Avaruusmaailma, johon peli sijoittuu.
     */
    public Avaruus kerroMaailma() {
        
        return this.maailma;
        
    }
    
    /**
     * Asettaa pelikentäksi tiedostosta löytyvän kentän. Jos annettu tiedosto on null,
     * ei metodi tee mitään.
     * @param tiedosto Pelikentän tiedosto.
     */
    public void asetaPelimaailma( String tiedosto ) {
        
        if ( tiedosto != null ) {
            
            this.lopeta();
            this.pelikenttaTiedosto = tiedosto;
            this.maailma = null;
            
        }
        
    }
    
    /**
     * Asettaa pelikentäksi generoitavan kentän, jonka mitat ovat annetut.
     * @param leveys Generoitavan kentän leveys.
     * @param korkeus Generoitavan kentän korkeus.
     * @throws Exception Poikkeus, joka kertoo, että annetut mitat olivat virheelliset.
     */
    public void asetaPelimaailma( int leveys, int korkeus ) throws Exception {
        
        this.lopeta();
        this.maailma = new Avaruus( leveys, korkeus );
        this.pelikenttaTiedosto = null;
        
    }

    /**
     * Arpoo annetulle kappaleelle laillisen sijainnin avaruusmaailmasta. Sijaintia
     * yritetään arpoa niin kauan, kunnes laillinen sijainti saavutetaan. Tämä voi
     * jossakin tapauksessa aiheuttaa ikuisen silmukan, joten kutsujan on todella
     * tiedettävä, mitä tekee. Laillinen alue on sellainen, joka ei leikkaa yhtäkään
     * avaruuden törmättävissä olevaa kappaletta.
     * @param kappale Kappale, jolle sijainti arvotaan.
     * @throws Exception Poikkeus kertoo, että kappale on liian iso avaruuteen tai
     * kappaletta ei onnistuttu lukuisista yrityksistä huolimatta sovittamaan
     * avaruuteen.
     */
    public void arvoSijainti( Kappale kappale ) throws Exception {

        //Arvotaan sijainti.
        Koordinaatit sijainti = new Koordinaatit( this.maailma.kerroKoordinaatisto(),
                								  Math.random() * this.maailma.kerroKoordinaatisto().kerroLeveys(),
                								  Math.random() * this.maailma.kerroKoordinaatisto().kerroKorkeus() );
        
        Alue paikka = kappale.kerroAlue();
        
        paikka.asetaSijainti( sijainti );
        
        //Arvotaan kappaleelle sijaintia, kunnes sijainti on laillinen (so. alue ei leikkaa
        //mitään törmättävissä olevaa kappaletta).
        int ind = 0;
        while ( this.maailma.onLaitonAlue( paikka ) && ind < 10000 ) {
            
            sijainti.asetaSijainti( Math.random() * this.maailma.kerroKoordinaatisto().kerroLeveys(),
                    				Math.random() * this.maailma.kerroKoordinaatisto().kerroKorkeus() );
            
            ind++;
            
        }
        
        if ( ind == 10000 ) {
            
            throw new Exception( "Kappaletta ei saatu mahtumaan avaruuteen huolimatta tuhansista yrityksistä. " + 
                            	 "Kappaleen alue olisi kuitenkin koordinaatistoon sopiva." );
            
        }
        
        kappale.asetaMaailmaan( this.maailma, sijainti.kerroSijaintiX(), sijainti.kerroSijaintiY() );
        
    }
    
    /**
     * Arpoo annetun pelaajan alukselle uuden sijainnin. Jos pelaaja ei ole pelissä tai
     * pelaajalla ei ole alusta, ei metodi tee mitään. 
     * @param pelaaja Pelaaja, jonka alukselle uusi sijainti arvotaan.
     * @throws RuntimeException Vapaasti heitettävä poikkeus kertoo, että alusta ei kerta
     * kaikkiaan saatu mahtumaan avaruuteen. Tällaista tilannetta ei pitäisi syntyä, mutta
     * jos tätä tapahtuu, on ohjelman jollakin hallitulla tavalla kyettävä se käyttäjälle
     * kertomaan.
     */
    public void arvoPelaajanSijainti( Pelaaja pelaaja ) {
        
        try {
            
            if ( pelaaja.kerroPeli() == this ) {
                
                KappalePelaajanAlus alus = pelaaja.kerroAlus();
                
                if ( alus != null )
                    this.arvoSijainti( pelaaja.kerroAlus() );
                
            }
            
        }
        catch ( Exception virhe ) {

            throw new RuntimeException( "Pelaajan \"" + pelaaja.kerroNimi() + "\" alukselle " +
                    					"ei kyetty arpomaan uutta sijaintia:\n" + virhe.getMessage() );
            
        }
        
    }
    
    /**
     * Jos peliä ei ole vielä voitettu, muuttaa pelaajien pisteitä sellaisen tilanteen
     * edellyttämällä tavalla, missä <CODE>syy</CODE> on tappanut <CODE>tapetun</CODE>.
     * Jos pelaaja tappaa toisen pelaajan, saa tappaja yhden pisteen. Jos pelaaja tappaa
     * itsensä tai tappajana ei ole mikään pelaajan ohjaama alus, saa hän -1 pistettä.
     * Tutkii, onko joku pelaaja nyt täyttänyt voiton ehdot.
     * @param tapettu Pelaaja, joka on tapettu.
     * @param syy Kappale, joka on syynä pelaajan kuolemiseen (esim. ammuksen ampunut alus).
     */
    public void suoritaTappo( Pelaaja tapettu, Kappale syy ) {
    
        if ( this.peliVoitettu || tapettu == null )
            return;
        
        if ( syy == tapettu.kerroAlus() ) {
            
            //Tappoi itse itsensä. -1 piste?
            tapettu.muutaPisteet( tapettu, -1 );
            
        }
        else if ( syy instanceof KappalePelaajanAlus ) {
            
            Pelaaja tappaja = ( ( KappalePelaajanAlus )syy ).kerroPelaaja();
            
            if ( tappaja != null ) {
                
                //Lisätään pelaajalle jokin tappo tai jotain.
                tappaja.muutaPisteet( tapettu, 1 );
                
            }
            
        }
        else {
            
            //Syynä kuolemaan jokin muu. -1 piste.
            //Jos syy == null, tullaan myös tänne.
            tapettu.muutaPisteet( null, -1 );
            
        }

        this.tutkiVoittaja();

    }
    
    /**
     * Asettaa pistemäärän, joka voittoon tarvitaan. Jos annettu pistemäärä on virheellinen
     * (ei ole välillä 1-<CODE>VOITON_MAKSIMIPISTEMAARA</CODE>), heitetään poikkeus.
     * Nollataan pelaajien pisteet.
     * @param voitonPistemaara Pistemäärä, joka voittoon tarvitaan.
     * @throws Exception Poikkeus, joka kertoo, että annettu pistemäärä on virheellinen.
     */
    public void asetaVoitonPistemaara( int voitonPistemaara ) throws Exception {
        
        if ( voitonPistemaara < 1 || voitonPistemaara > AvaruussotaPeli.VOITON_MAKSIMIPISTEMAARA )
            throw new Exception( "Pelin voiton pistemäärää ei voitu asettaa. Pistemäärän täytyy olla välillä 1-" +
                    			 AvaruussotaPeli.VOITON_MAKSIMIPISTEMAARA + "." );
        
        this.voitonPistemaara = voitonPistemaara;
        this.nollaaPelaajienPisteet();
        
    }
    
    /**
     * Kertoo pelin voittaneen pelaajan indeksin tai -1, jos pelin voittamisen ehtoja
     * ei ole täyttänyt vielä kukaan pelaaja. Nostaa tai laskee pelin voittamisen merkkinä
     * olevan lipun.
     * @return Pelaajan, joka pelin on voittanut, indeksi tai -1, jos peliä ei ole voitettu.
     */
    public int tutkiVoittaja() {
        
        for ( int ind = 0; ind < this.pelaajat.size(); ind ++ ) {
            
            Pelaaja tutkittava = ( Pelaaja )this.pelaajat.get( ind );
            if ( tutkittava.kerroPisteet() >= this.voitonPistemaara ) {
                
                this.peliVoitettu = true;
                return ind;
                
            }
            
        }
        
        this.peliVoitettu = false;
        return -1;
        
    }
    
    /**
     * Kertoo, onko pelin voittamisen merkiksi nostettu lippu. Metodi ei etsi voittajaa,
     * vaan kertoo, vain onko sellainen aiemmin löydetty ja lippu sen merkiksi nostettu.
     * @return Totuusarvo, joka kertoo, onko peli voitettu.
     */
    public boolean onVoitettu() {
        
        return this.peliVoitettu;
        
    }

    /**
     * Luo uuden pelimaailman. Jos pelimaailmaksi on asetettu tiedosto, ladataan se.
     * Jos pelimaailmaksi on asetettu maailman mitat, generoidaan se. Jos latauksessa
     * tai generoinnissa tapahtuu virheitä, tai tiedostoa tai mittoja ei ole asetettu,
     * heitetään poikkeus.  
     * @throws Exception Poikkeus, jos latauksessa, generoinnissa tai alkuasetuksissa on
     * virheitä.
     */
    private void luoUusiMaailma() throws Exception {
        
        GeneroijaPelikentta generoija = new GeneroijaPelikentta();
        
        if ( this.pelikenttaTiedosto != null ) {
            
            //Pelimaailmaksi on asetettu tiedosto.
            this.maailma = generoija.generoiPelimaailma( this.pelikenttaTiedosto );
            
        }
        else if ( this.maailma != null ) {
            
            //Pelimaailmaksi on asetettu tiettyjen mittojen mukaan generoitava kenttä.
            int leveys = this.maailma.kerroKoordinaatisto().kerroLeveys();
            int korkeus = this.maailma.kerroKoordinaatisto().kerroKorkeus();
            
            this.maailma = generoija.generoiPelimaailma( leveys, korkeus );
            
        }
        else {
            
            //Pelimaailmaksi ei ole valittu mitään.
            throw new Exception( "Pelimaailmaa ei ole asetettu." );
            
        }
        
    }
    
    /**
     * Heittää poikkeuksen, jos pelin asetuksissa on jokin käynnistystä estävä
     * virhe.
     * @throws Exception Poikkeus kertoo, että pelin asetuksissa on käynnistyksen
     * estävä virhe.
     */
    public void tutkiKaynnistettavyys() throws Exception {
        
        if ( this.pelaajat.size() < 2 || this.pelaajat.size() > AvaruussotaPeli.PELAAJIEN_MAKSIMIMAARA ) {
            
            throw new Exception( "Peliä ei voida käynnistää. Pelissä pitää olla 2-" +
                    			 AvaruussotaPeli.PELAAJIEN_MAKSIMIMAARA + " pelaajaa." );
        
        }
        
    }

    /**
     * Käynnistää pelin luomalla maailman, nollaamalla pelaajien pisteet, arpomalla pelaajien
     * aluksille sijainnit, pistämällä maailman pyörimään ja tekoälyt miettimään. Lopettaa
     * mahdollisen aiemman pelin.
     * @throws Exception Poikkeus kertoo, että alkuasetukset ovat pielessä.
     */
    public void kaynnista() throws Exception {

        this.lopeta();

        //Heittää poikkeuksia, jos jokin on asetus on pielessä.
        this.tutkiKaynnistettavyys();
        
        this.luoUusiMaailma();
        this.nollaaPelaajienPisteet();
        
        //Laitetaan pelaajien alukset maailmaan.
        for ( int ind = 0; ind < this.pelaajat.size(); ind++ )
            this.arvoSijainti( ( ( Pelaaja )this.pelaajat.get( ind ) ).kerroAlus() );

        this.maailmaSaie.kaynnista( this.maailma );
        this.tekoalySaie.kaynnista();
        
    }
    
    /**
     * Lopettaa pelin lopettamalla tekoälyjen miettimisen, poistamalla kaikki kappaleet
     * avaruudesta ja lopettamalla maailmaa pyörittävän säikeen.
     */
    public void lopeta() {
        
        this.tekoalySaie.lopeta();
        
        if ( this.maailma != null )
            this.maailma.poistaKaikkiKappaleet();
        
        this.maailmaSaie.lopeta();
        
    }
    
    /**
     * Lopettaa pelin, poistaa maailman ja poistaa kaikki pelaajat pelistä.
     */
    public void tyhjenna() {
        
        this.lopeta();
        this.maailma = null;
        this.poistaKaikkiPelaajat();
        
    }
    
    /**
     * Piirtää pelimaailmasta halutun kokoisen kuvan annetulle piirtokontekstille keskittäen
     * kuvan annettuun kappaleeseen. Jos kappaleella ei ole sijaintia tai se ei sijaitse 
     * maailman koordinaatistossa, keskittää koordinaatteihin (0,0). Jos näkymän mitat
     * ovat avaruuden mittoja suuremmat, ei näkymä välttämättä piirry täysin oikein. 
     * @param piirtokonteksti Piirtokonteksti, jolle näkymä piirretään.
     * @param keskitettava Kappale, johon näkymä keskitetään.
	 * @param vasen Näkymän vasemman yläkulman x-koordinaatti piirtokontekstilla.
	 * @param yla Näkymän vasemman yläkulman y-koordinaatti piirtokontekstilla.
     * @param leveys Näkymän leveys.
     * @param korkeus Näkymän korkeus.
     */
    public void piirraNakyma( Graphics piirtokonteksti, Kappale keskitettava, int vasen, int yla, int leveys, int korkeus ) {
        
        //Synkronoidaan, että voidaan laskea kappaleen keskipiste, eikä se sitten enää muutu.
        synchronized ( this.maailma ) {
            
            double x = 0;
            double y = 0;
            Koordinaatit sijaintiKeskipiste = keskitettava.kerroAlue().kerroSijainti();        
            
            if ( sijaintiKeskipiste != null && sijaintiKeskipiste.kerroKoordinaatisto() == this.maailma.kerroKoordinaatisto() ) {
                
                x = sijaintiKeskipiste.kerroSijaintiX();
                y = sijaintiKeskipiste.kerroSijaintiY();
                
            }
            
            this.maailma.piirraNakyma( piirtokonteksti, x, y, vasen, yla, leveys, korkeus );
            
        }
        
    }
    
}
